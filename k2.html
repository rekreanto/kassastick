<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kassastick</title>
  <script src="barcodes.js"></script>
  <script src="kassastick--data.js"></script>

  <script src="k2--prelude.js"></script>
  <script src="k2--nolay.js"></script>

  <link href= "k2--layout.css" rel="stylesheet">
  <link href= "k2--style.css" rel="stylesheet">
  
  <script>
    // PARSE DATA
    const fill_in = (key, val, templ) => {
      const val_ = val.replace( '...', templ )
      return key === 'ean' ? val_.replace( /\s+/g, '' ): val_;
    } 
    lines = DATA.str.split(/\n+/);
    const groups = DATA.groups;
    let current = null;
    lines.forEach(
      Match
        ( /^\s*\/\s*/ , path => groups.push( {path:path, items:[], template:{}} )
        , /^\s*\#\s*/ , key  => {
          //console.log(key)
          groups[groups.length-1].items.push([key,current={key}]) 
          }
        , /^\s*\*\s*([a-zA-Z\-]+)\s+/, (key, val) => groups[groups.length-1].template[key]=val
        , /^\s*([a-zA-Z\-]+)\s+/, (key, val) => current[key] = fill_in(key,val,groups[groups.length-1].template[key])
        , otherwise  , line => {}
        )
    );
  </script>

  <script>
  </script>
  
  <script>
    document.addEventListener('DOMContentLoaded', ( ev ) => 
    {
    // RENDER page
      const ENV = {};
    // HANDLERS
      const handleColorButton = c => ev => {
        ENV.inputField.value = Match
          ( /\[…([a-z]+)…\]$/i , chars => `[…${chars}${c}…]`
          , otherwise          , _     => `[…${c}…]` 
          )( ENV.inputField.value )
        ;
      };
      const handleEnterButton = ev => {
        ENV.inputField.value = Match
          ( /\[…([a-z]+)…\]$/i , chars => `[${chars}]`
          , /\[([a-z]+)\]$/i , chars =>   `[${chars}]`
          , otherwise          , chars => `[${chars}]` 
          )( ENV.inputField.value )
        ;
      };
      const handleResetButton = ev => { 
        ENV.inputField.value = '';
      }
      const handleDeleteButton = ev => {
        const str = ENV.inputField.value;
        ENV.inputField.value = str.substring( 0, str.length-1 );
      }
      const handleFocus = ev => { ENV.input.dataset.focused = true; }
      const handleBlur  = ev => { ENV.input.dataset.focused = false; }

      // HANDLE SELECTION/ DISPLAY BARCODE
      let active = { item: null, barcode: null };
      handleReset = e => {
        // console.log('reset')
        document.body.dataset.state = 'browsing';
        if( active.item ) active.item.classList.remove( 'selected' );
        if( active.barcode ) active.barcode.parentNode.removeChild( active.barcode );
        active.barcode = null;
        active.item = null;
      }
      document.body.addEventListener( 'mouseup', handleReset );
      
      const handleItemClick = e => {
            e.stopPropagation();
            const item = e.target;
            if( !item.dataset.ean ) return;
            handleReset();

            // REFLECT STATE
            document.body.dataset.state = 'selected';
            item.classList.add( 'selected' );
            active.item = item;

            // PRODUCE BARCODE
            const eanstr = item.dataset.ean;
            console.log( 'Selected: ', eanstr )
            const eansvg = str2svg(  eanstr );
            const barcode_display = document.createElement( 'div' );
            barcode_display.innerHTML =  eansvg;
            barcode_display.classList.add( 'barcode-display' )
            item.after( barcode_display );
            
            // EXIT -- redundant -- aldready done in handleReset
     
            // ENTRY
            active.barcode = barcode_display;
          }
      
      const ccd_markup = Case
        ( _String,  ccd => {console.log('tp',typeof(ccd)); return ['<div>']}
 
        , _ => [ '<div>' ]
        )
      ;
    // MARKUP
      const ki2Item = ( [ key, item ] ) =>
        [ '<button>'
        , [ '.', 'item' ]
        , [ '%ean', item.ean ]
        , key
        , ccd_markup( item.ccd )
        ]

      const grpGroup = g => 
        [ '<div group>'
        , g.path
        , " / "
        , $2.each( g.items )( ki2Item )
        ]
      ;

      const Listing = 
        [ '<div listing listing>'
        , $2.each( DATA.groups )( grpGroup )
        , [ '<footer>' ]  
        , [ '!click', handleItemClick ]
        ]
      ;

      const Display =
        [ '<div display display>'
        , [ '<button deleteBtn del>', "<"
          , [ '!click', handleDeleteButton ]
          ]
        , [ '<input inputField inp>'
          , [ '!focus', handleFocus ]
          , [ '!blur' , handleBlur ]
          ]
        , [ '<button resetBtn res>', "x"
          , [ '!click', handleResetButton ]
          ]
        ]
      ;
      const colorBtn = c =>
          [ `<button ${c} ${c}>`
          , [ '.', "color-button" ]
          , [ '%color', c ]
          , [ '!click', handleColorButton( c ) ]
          ]
      const Keyboard = 
        [ '<div keyboard keyboard>'
        , $2.each( 'roygbvns' )( colorBtn )
        , [ '<button enterBtn E>'
          , "↵"
          , [ '!click', handleEnterButton ] 
          ] 
        ]
      ;

      const Input = 
        [ '<div input>'
        , Display
        , Keyboard
        ]
      const Main = 
        [ '<div main>'
        , Listing
        , Input
        , [ '<div>', [ '@id', 'shield' ] ]
        ]
      ;
    // INTERPRET page definition
      $.syntax.texp2fn( Main )( 
          { node: document.body
          , env: ENV
          }
      );
    }
  );
  </script>
</head>
<body>



</body>
</html>
