<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kassastick</title>
  <script src="barcodes.js"></script>
  <script src="kassastick--data.js"></script>

  <script src="k2--prelude.js"></script>
  <script src="k2--nolay.js"></script>

  <link href= "k2--layout.css" rel="stylesheet">
  <link href= "k2--style.css" rel="stylesheet">
  
  <script>
    // PARSE DATA
    const fill_in = (key, val, templ) => {
      const val_ = val.replace( '...', templ )
      return key === 'ean' ? val_.replace( /\s+/g, '' ): val_;
    } 
    lines = DATA.str.split(/\n+/);
    const groups = DATA.groups;
    let current = null;
    lines.forEach(
      Match
        ( /^\s*\/\s*/ , path => groups.push( {path:path, items:[], template:{}} )
        , /^\s*\#\s*/ , key  => {
          //console.log(key)
          groups[groups.length-1].items.push([key,current={key}]) 
          }
        , /^\s*\*\s*([a-zA-Z\-]+)\s+/, (key, val) => groups[groups.length-1].template[key]=val
        , /^\s*([a-zA-Z\-]+)\s+/, (key, val) => current[key] = fill_in(key,val,groups[groups.length-1].template[key])
        , otherwise  , line => {
                    // console.log( `????:${line}` )  
                  }
        
        )
    );
  </script>

  <script>
  </script>
  
  <script>
    document.addEventListener('DOMContentLoaded', ( ev ) => 
    {
    // RENDER page
      const ENV = {};


      const transform_enter = Match
        ( /\[…([a-z]+)…\]$/i , chars => `[${chars}]`
        , otherwise          , chars => `[${chars}]` 
        )
      ;
      const handleColorButton = c => ev => {
        const str = ENV.inputField.value;
        ENV.inputField.value = Match
          ( /\[…([a-z]+)…\]$/i , chars => char => `[…${chars}${char}…]`
          , otherwise          , _     => char => `[…${char}…]` 
          )( str )( c )
        ;
      };
      const handleEnterButton = ev => {
        console.log( ev )
        const str = ENV.inputField.value;
        ENV.inputField.value = Match
          ( /\[…([a-z]+)…\]$/i , chars => `[${chars}]`
          , otherwise          , chars => `[${chars}]` 
          )( str )
        ;
      };

      const ki2Item = ( [ key, item ] ) =>
        [ '<button>'
        , [ '.', 'item' ]
        , key
        ]

      const grpGroup = g => 
        [ '<div group>'
        , g.path
        , " / "
        , $2.each( g.items )( ki2Item )
        ]
      ;
      const Listing = 
        [ '<div listing listing>'
        , $2.each( DATA.groups )( grpGroup )  
        ]
      ;

      const Display =
        [ '<div display display>'
        , [ '<button deleteBtn del>', "<" ]
        , [ '<input inputField inp>' ]
        , [ '<button resetBtn res>', "x" ]
        ]
      ;
      const colorBtn = c =>
          [ `<button ${c} ${c}>`
          , [ '.', "color-button" ]
          , [ '%color', c ]
          , [ '!click', handleColorButton( c ) ]
          ]
      const Keyboard = 
        [ '<div keyboard keyboard>'
        , $2.each( 'roygbvns' )( colorBtn )
        , [ '<button enterBtn E>'
          , "↵"
          , [ '!click', handleEnterButton ] 
          ] 
        ]
      ;

      const Input = 
        [ '<div input>'
        , Display
        , Keyboard
        ]
      const Main = 
        [ '<div main>'
        , Listing
        , Input
        ]
      ;
    // INTERPRET page definition
      $.syntax.texp2fn( Main )( 
          { node: document.body
          , env: ENV
          }
      );

    // ADD event handlers
      // handle state focused = hidden special keyboard
      ENV.inputField.addEventListener( 'focus', ev => {
        ENV.input.dataset.focused = true;
      } );
      ENV.inputField.addEventListener( 'blur', ev => {
        ENV.input.dataset.focused = false;
      } );
      // handle delete button
      ENV.deleteBtn.addEventListener( 'click', () => {
        const str = ENV.inputField.value;
        ENV.inputField.value = str.substring( 0, str.length-1 );
      } );
      // handle delete button
      ENV.resetBtn.addEventListener( 'click', () => {
        ENV.inputField.value = '';
      } );
    }
  );
  </script>
</head>
<body>



</body>
</html>
